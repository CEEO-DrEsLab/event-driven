<!-- 
	Created by Caleb Lucas-Foley
	2016-07-11
-->

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Layout concept</title>
	<style>
	* {
		margin: 0px;
	}
	html, body {
		height: 100%;
		width: 100%;
	}
	/* Column column-header class */
	.column-header {
		text-align: center;
		background-color: magenta;
	}
	/* Left column (trigger channel sidebar) */
	.left-column {
		width: 250px;
		float: left;
	}
	/* Right column (action channel sidebar) */
	.right-column {
		width: 250px;
		float: right;
	}
	/* Center column (code area) */
	.center-column {
		margin: auto;
	}
	/* Class for left and right sidebars */
	.sidebar {
		height: 100%;
		background-color: chartreuse;
		overflow: auto;
		border: inset;
	}
	/* Class for code areas */
	.code-area {
		height: 100%;
		background-color: indigo;
		overflow: auto;
		border: inset;
	}

	/* Channel block */
	.channel-block {
		height: 100px;
		width: 100px;
		text-align: center;
		background-color: azure;
		margin: 10px auto; /* centers horizontally */
		border-style: outset;
	}
	/* Button to add new blocks */
	.button-add {
		height: 50px;
		width: 50px;
		display: block;
		margin: 10px auto;
	}
	/* Code block parent */
	.code-block {
		height: 100px;
		width: 200px;
		border-style: outset;
	}
	/* Trigger-specific blocks */
	.trigger-block {
		float: right;
		margin-right: 50%;
		background-color: forestgreen;
	}
	/* Action-specific blocks (also used for button positioning) */
	div.action-block {
		background-color: crimson;
	}
	.action-block {
		display: block;
		position: relative;
		left: 50%;
	}
	/* Trigger-action pair container */
	.pair-container {
		background-color: cyan;
		margin: 10px; /* centers horizontally */
		min-height: 100px;
	}
	</style>
	<script async>
	//////////////////////////////////////////////////////////////////////
	///////////////////////////// Constants //////////////////////////////
	//////////////////////////////////////////////////////////////////////

	// EV3 Constants
	var PORT_TYPES = {
		"1": "sensor",
		"2": "sensor",
		"3": "sensor",
		"4": "sensor",
		"A": "motor",
		"B": "motor",
		"C": "motor",
		"D": "motor"//,
		// "BRICK BUTTON": "brick in",
		// "BRICK LIGHT": "brick out",
		// "BRICK SOUND": "brick out",
	};
	var SENSORS = ["Touch Sensor", "Ultrasonic Sensor", "Color Sensor"];
	var MOTORS = ["Large Motor", "Medium Motor"];


	//////////////////////////////////////////////////////////////////////
	///////////////////////////// Code Model /////////////////////////////
	//////////////////////////////////////////////////////////////////////

	var portConfig = {}; // {<port#>:<peripheral>}

	var triggerChannels = [];

	var actionChannels = [];

	var channels = ["tempchannel1", "tempchannel2"];

	var code = {}; //{<channel>:{<trigger>:[<action>,],},};


	//////////////////////////////////////////////////////////////////////
	/////////////////////// Port Data Propogation ////////////////////////
	//////////////////////////////////////////////////////////////////////

	// The selected options in the select nodes in this list must not appear in the other lists as options
	var exclusivePortLists = [];
	var availablePorts = Object.keys(PORT_TYPES);
	var claimedPorts = [];

	function addNewOption(parent, content) {
		var newOption = document.createElement("option");
		newOption.text = content;
		parent.add(newOption);
	}

	function updatePortLists() {
		console.log("updating ports")
		console.log(availablePorts);
		console.log(claimedPorts);
		for (i in exclusivePortLists) {
			// Remove all non-selected options
			var temp = exclusivePortLists[i].value;
			exclusivePortLists[i].length = 0;
			addNewOption(exclusivePortLists[i], temp);

			// Re-add all available ports to each list
			for (k in availablePorts) {
				console.log("adding port " + availablePorts[k] + " to list " + i);
				addNewOption(exclusivePortLists[i], availablePorts[k]);
			}
		}
		console.log("update done");
	}


	//////////////////////////////////////////////////////////////////////
	////////////////////////// New Block Setup ///////////////////////////
	//////////////////////////////////////////////////////////////////////

	// Makes a custom channel (GUI only)
	function makeChannel() {
		var peripheral = prompt("Enter Peripheral Name:");
		var port = prompt("Which port is the " + peripheral + " in?");
		portConfig[port] = peripheral;
		return [peripheral, port];
	}

	function makeTriggerBlock () {
		var newTrigger = document.createElement("div");
		newTrigger.className = "code-block trigger-block";
		newTrigger.innerHTML = "Port:";
		var channelSelect = document.createElement("select");
		for (i in channels) {
			addNewOption(channelSelect, channels[i]);
		}
		newTrigger.appendChild(channelSelect);
		return newTrigger;
	}

	function makeActionBlock () {
		var newAction = document.createElement("div");
		newAction.className = "code-block action-block";
		newAction.innerHTML = "Port:";
		var channelSelect = document.createElement("select");
		for (i in channels) {
			addNewOption(channelSelect, channels[i]);
		}
		newAction.appendChild(channelSelect);
		return newAction;
	}

	// function makeChannelBlock(type) {
	// 	var channelData = makeChannel();
	// 	if (channelData[0] != null && channelData[1] != null) {
	// 		var newChannelBlock = document.createElement("div");
	// 		newChannelBlock.className = "channel-block";
	// 		newChannelBlock.innerHTML = channelData[0] + "<br/>(port: " + channelData[1] + ")";
	// 		return newChannelBlock;
	// 	} else {
	// 		return null;
	// 	}
	// }

	// Make a new channel block (to be added to a sidebar) with an exclusive port selector
	// TODO: modularize
	function makeEditableChannelBlock (type) {
		var newChannelBlock = document.createElement("div");
		newChannelBlock.className = "channel-block";
		var portSelect = document.createElement("select");
		for (i in availablePorts) {
			var newOption = document.createElement("option");
			newOption.text = availablePorts[i];
			portSelect.add(newOption);
		}
		exclusivePortLists.push(portSelect);
		portSelect.oldValue = portSelect.value;
		console.log(availablePorts.splice(availablePorts.indexOf(portSelect.value), 1));
		claimedPorts.push(portSelect.value);

		updatePortLists();

		portSelect.onchange = function () {	
			console.log("change detected");
			console.log(this.oldValue);
			console.log(this.value);

			availablePorts.push(this.oldValue);
			claimedPorts.splice(claimedPorts.indexOf(this.oldValue), 1);

			availablePorts.splice(availablePorts.indexOf(this.value), 1);
			claimedPorts.push(this.value);

			updatePortLists();
		};

		var peripheralSelect = document.createElement("select");
		for (i in (type == "trigger" ? SENSORS : MOTORS)) {
			var newOption = document.createElement("option");
			newOption.text = (type == "trigger" ? SENSORS : MOTORS)[i];
			peripheralSelect.add(newOption);
		}
		peripheralSelect.onchange = function () {
			portConfig[currentPortSelected] = peripheralSelect.value;
		}

		newChannelBlock.appendChild(portSelect);
		newChannelBlock.appendChild(peripheralSelect);

		return newChannelBlock;
	}


	//////////////////////////////////////////////////////////////////////
	/////////////////////// Adding New Code Blocks ///////////////////////
	//////////////////////////////////////////////////////////////////////

	// Adds a new channel block (of the specified type) above the specified element
	function addChannelBlockAbove(button, type) {
		if (type != "trigger" && type != "action") {
			alert("Error creating channel (invalid channel type)");
			return;
		}
		var newChannelBlock = makeEditableChannelBlock(type);
		if (newChannelBlock != null) {
			button.parentNode.insertBefore(newChannelBlock, button);
		} else {
			alert("Error creating channel (please specify port and peripheral)");
		}
	}

	// Adds a new action block above the specified element
	function addActionAbove(button) {
		button.parentNode.insertBefore(makeActionBlock(), button);
	}

	// Adds a new trigger (with add-action button) above the specified element
	function addPairAbove(button) {
		var newPair = document.createElement("div");
		newPair.className = "pair-container";

		var newButton = document.createElement("button");
		newButton.className = "action-block";
		newButton.innerHTML = "+";
		newButton.setAttribute("onclick", "addActionAbove(this)");

		newPair.appendChild(makeTriggerBlock());
		newPair.appendChild(newButton);

		button.parentNode.insertBefore(newPair, button);
	}
	</script>
</head>

<body>
	<div class="left-column column-header">Trigger Channels:</div>
	<div class="right-column column-header">Action Channels:</div>
	<div class="center-column column-header">Code:</div>
	<div class="left-column sidebar">
		<button class="button-add" onclick="addChannelBlockAbove(this, 'trigger')">+</button>
	</div>
	<div class="right-column sidebar">
		<button class="button-add" onclick="addChannelBlockAbove(this, 'action')">+</button>
	</div>
	<div class="center-column code-area">
		<button class="button-add" onclick="addPairAbove(this)">+</button>
	</div>
</body>

</html>